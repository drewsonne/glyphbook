<!doctype html>
<html lang="en">
<head>
    <title>Glyphbook</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="js/jquery-3.4.1.min.js" type="text/javascript"></script>
    <link href="css/app.css" rel="stylesheet">

    <script src="js/paper-core.js" type="text/javascript"></script>
    <script src="js/paper-full.js" type="text/javascript"></script>
    <script src="js/app.js" type="text/javascript"></script>
    <script type="text/javascript">

      window.onload = function () {
        paper.install(window)

        paper.setup('notebook')

        let grid
        let artifact
        let annotationController

        let gridLayer = new Layer()
        let artifactLayer = new Layer()
        let annotationLayer = new Layer()

        function render () {
          grid.draw(view)
          artifact.draw(view)
          artifact.fitToView(view)
        }

        gridLayer.activate()
        grid = new GBGrid(gridLayer)
        grid.on('first-draw', function () {
          console.log('grid: first-draw')
          artifactLayer.activate()
          artifact = new GBArtifact()
          artifact.on('first-draw', function () {
            console.log('artifact: first-draw')
            annotationController = new GBAnnotations(annotationLayer)
          })

          $.ajax(
            '/glyphbook/api/v1/artifact/6716.json',
            {
              success: function (data, status) {
                console.log('ajax: success')

                artifact.set_href(
                  data.media[0].href,
                  view,
                )
                render()
              },
            },
          )

        }).draw(view)

        let resizeTimer
        view.onResize = function (event) {
          clearTimeout(resizeTimer)
          resizeTimer = setInterval(function () {
            render()
            clearTimeout(resizeTimer)
          }, 10)
        }

        view.onMouseDown = function (event) {
          annotationController.handleMouseDown(event)
        }

        view.onMouseDrag = function (event) {
          annotationController.handleMouseDrag(event)
        }
      
        view.onMouseUp = function (event) {
          annotationController.handleMouseUp(event)
        }
        imageObj.position = view.center
        imageObj.bringToFront()
        imageObj.on('load', function () {
          let xScaleFactor = undefined
          let yScaleFactor = undefined
          if (imageObj.height > view.bounds.height) {
            let targetHeight = view.bounds.height * 0.9
            yScaleFactor = targetHeight / imageObj.height
          }

          if (imageObj.width > view.bounds.width) {
            let targetWidth = view.bounds.width * 0.9
            xScaleFactor = targetWidth / imageObj.width
          }

          let scaleFactor = Math.min(yScaleFactor, xScaleFactor)
          imageObj.scale(scaleFactor)
        })

      }

      function render () {
        renderGrid()
        flushImage()
      }

      window.onload = function () {
        paper.setup('notebook')

        view.onResize = handleResize

        $.ajax(
          '/glyphbook/api/v1/artifact/6716.json',
          {
            success: function (data, status) {
              imageHref = data.media[0].href
              render()
            },
          },
        )
      }

    </script>

</head>
<body>
<div class="wrapper">
    <div class="title">
        <h1>Glyphbook</h1>
    </div>
    <div class="workspace">
        <canvas id="notebook" resize></canvas>
    </div>
    <div class="toolbar">Toolbar</div>
</div>

</body>
